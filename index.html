<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/mui.min.css">
    <link rel="stylesheet" type="text/css" href="css/app-base.css" />
    <link rel="stylesheet" type="text/css" href="css/app-index.css" />
</head>

<body>
    <div id="app">
        <router-view></router-view>
    </div>
    <script src="js/vue.js"></script>
    <script src="js/vue-router.min.js"></script>
    <script src="js/vue-resource.min.js"></script>
    <script src="js/vue-async-data.js"></script>
    <script src="js/hammer.min.js"></script>
    <script src="js/vue-touch.js"></script>
    <script src="js/echarts.js"></script>
    <script src="js/pie.js"></script>
    <script>
    Vue.use(VueAsyncData);
    Vue.use(VueTouch);
    Vue.config.debug = true;

    // 作为入口
    require(
        [
            'echarts',
            'echarts/chart/pie'
        ]
    );

    var Index = Vue.extend({

        data: function() {
            imgs = ['img/test3.jpg', 'img/test2.jpg', 'img/test1.jpg','img/test4.jpg','img/test5.jpg','img/test6.jpg','img/test7.jpg','img/test8.jpg','img/test9.jpg','img/test10.jpg','img/test11.jpg','img/test12.jpg'];
            var cc = Math.round(Math.random() * imgs.length-1);
            return {
                Index: {
                    bgimg: imgs[cc],
                    siteInfo: {
                        sitename: "Bookkeeper"
                    }
                }
            }
        },
        methods: {
            goBack: function(e) {
                history.go(-1);
            }
        },
        template: '<header class="header mui-bar mui-bar-nav"><h1 id="title" class="mui-title">{{Index.siteInfo.sitename}}</h1></header>' +
            '<div class="mui-content index-page" style="background-image: url({{Index.bgimg}})">' +
            '<div class="button-box">' +
            '<button v-link="chart" class="mui-btn go-button">开始记账</button><br>' +
            '<span></span>' +
            '</div>' +
            '</div>'

    })

    var Chart = Vue.extend({

        data: function() {
            var billList = [];
            if(localStorage.billList){
                billList = JSON.parse(localStorage.billList);

            }

            return{
                showModal:false,
                showAddModal:false,
                siteInfo:{
                    sitename:"Bookkeeper"
                },
                bills:billList,
                payment:0,
                revenue:0
            }
        },
        asyncData: function(resolve, reject) {
            var clist = [];
            var cdata = [];
            
            for(j = 0;j<this.$data.bills.length;j++){
                this.$data.payment += parseInt(this.$data.bills[j].price);
                if(clist.indexOf(this.$data.bills[j].category)==-1){
                    clist.push(this.$data.bills[j].category);
                    cdata.push({
                    'name':this.$data.bills[j].category,
                    'value':0
                })
                }
                
            }
            for(i=0;i<this.$data.bills.length;i++){
                for(n=0;n<cdata.length;n++){
                    if(this.$data.bills[i].category == clist[n]){
                        cdata[n].value = cdata[n].value + parseInt(this.$data.bills[i].price);
                    }
                }
                
            }
            var self = this;
            
            setTimeout(function() {
                self.$http.get('data/servicelist.json', function(data, status, request) {
                    resolve({
                        
                    })
                    self.$nextTick(function() {
                        var myChart = require('echarts').init(document.getElementById('chart'));
                        myChart.setOption({
                            backgroundColor: 'rgb(156, 39, 176)',
                            calculable: false,
                            tooltip: {
                                trigger: 'item',
                                formatter: "{b} : {c} ({d}%)"
                            },
                            calculable: true,
                            series: [{
                                type: 'pie',
                                radius: ['50%', '70%'],
                                itemStyle: {
                                    normal: {
                                        label: {
                                            show: true
                                        },
                                        labelLine: {
                                            show: true
                                        }
                                    }
                                },
                                data:cdata
                            }]
                        });
                    });

                }).error(function(data, status, request) {

                });

            }, 1000)
        },
        methods: {
            goBack: function(e) {
                history.go(-1);
            },
            showAdd:function(){
                this.$data.showModal=true;
                this.$data.showAddModal =true;
            },
            close:function(){
                this.$data.showModal=false;
                this.$data.showAddModal =false;
            }
        },
        template: '<header class="header mui-bar mui-bar-nav"><a  v-on="click: goBack" class="mui-icon mui-icon-left-nav mui-pull-left"></a><button class="mui-btn mui-btn-link mui-btn-nav mui-pull-right"><span></span></button><h1 id="title" class="mui-title">{{siteInfo.sitename}}</h1></header>' +
             '<div class="modal-mask" v-if="showModal" v-transition="modal">'+
                '<div class="modal-wrapper">'+
                  '<div class="modal-container" v-if="showAddModal">'+
                    '<button v-touch="tap:close" class="close-modal-btn">×</button>'+
                    '<content select=".modal-header">'+
                      '<div class="modal-header">'+
                        '添加'+
                      '</div>'+
                    '</content>'+
                    '<content select=".modal-body">'+
                      '<div class="modal-body">'+
                        '<input class="doned-input" v-model="itemname" autofocus="autofocus">'+
                        '<button class="doned-btn" v-on="click:add "> Done </button>'+
                      '</div>'+
                    '</content>'+
                  '</div>'+
                  
                '</div>'+
              '</div>'+
            '<div class="mui-content chart-page">' +
                '<div class="chart">'+
                    '<div class="chart-box">'+
                        '<div id="chart"></div>'+
                        '<div class="chart-txt">'+
                            '<div class="chart-txt-left"><span>收入 ￥{{revenue}}</span></div>'+
                            '<div class="chart-txt-left"><span>支出 ￥{{payment}}</span></div>'+
                        '</div>'+
                    '</div>'+
                    '<div class="chart-list">'+
                        '<div class="time-line"></div>'+
                        '<ul>'+
                            '<li v-repeat="bill in bills">'+
                                '<div class="bill-icon"></div>'+
                                '<div class="bill-txt"><span class="bill-name">{{bill.category}}</span><span class="bill-price">{{bill.price}}</span><span class="bill-mark">{{bill.mark}}</span></div>'+
                            '</li>'+
                        '</ul>'+
                    '</div>'+
                '</div>'+
                '<div class="add-box"  v-link="add">' +
                    '<span>＋</span>' +
                '</div>' +
            '</div>'

    })
    
    var Add = Vue.extend({

        data: function() {
            return {
                Index: {
                    siteInfo: {
                        sitename: "Bookkeeper"
                    }
                },
                price:0,
                category:"",
                categoryList:[{"id":1,"name":"娱乐"},
                {"id":2,"name":"购物"},
                {"id":3,"name":"住房"},{"id":4,"name":"文教"},{"id":5,"name":"通讯"},{"id":6,"name":"餐饮"},{"id":7,"name":"娱乐"},
                {"id":8,"name":"购物"},{"id":9,"name":"娱乐"},
                {"id":10,"name":"购物"},
                {"id":11,"name":"住房"},{"id":12,"name":"文教"},{"id":13,"name":"通讯"},{"id":14,"name":"餐饮"},{"id":15,"name":"娱乐"},
                {"id":16,"name":"购物"}],
                inputNum:[1,2,3,4,5,6,7,8,9,0,'.']
            }
        },
        methods: {
            goBack: function(e) {
                history.go(-1);
            },
            setCategory:function(e){
                var lables = document.getElementsByClassName('category-on');
                for(i=0;i<lables.length;i++){
                    lables[i].removeAttribute("class"); 
                }
                e.target.setAttribute('class','category-on');
                this.$data.category = e.target.innerText;
            },
            inputThis:function(e){
                console.log(e);
                if(this.$data.price == 0){
                    this.$data.price = e.target.innerText; 
                }else{
                    this.$data.price += e.target.innerText;
                }
                 
            },
            delThis:function(){
                if(this.$data.price != 0){
                    this.$data.price = this.$data.price.substr(0,this.$data.price.length-1);
                    if(this.$data.price.length == 0){
                        this.$data.price = 0;
                    }
                }
            },
            doThis:function(){
                if(this.$data.price != 0 || this.$data.category != ""){
                    var newbill = {
                        'category': this.$data.category ,'price': this.$data.price,'mark':""
                    };
                    var billList = [];
                    if(localStorage.billList){
                        billList = JSON.parse(localStorage.billList);
                    }
                    billList.push(newbill);
                    localStorage.billList = JSON.stringify(billList);
                    console.log('done');
                }
            }
        },
        template: '<header class="header mui-bar mui-bar-nav"><a  v-on="click: goBack" class="mui-icon mui-icon-left-nav mui-pull-left"></a><h1 id="title" class="mui-title">{{Index.siteInfo.sitename}}</h1></header>' +
            '<div class="mui-content add-page">' +
                '<div class="add-price-box"><span class="add-price">￥{{price}}</span></div>'+
                '<div class="add-category">'+
                    '<ul>'+
                        '<li class="category-item" v-repeat="c in categoryList" v-touch="tap:setCategory"><div><div data="{{c.id}}">{{c.name}}</div></li>'+
                    '</ul>'+
                '</div>'+
                '<div class="add-input-box">'+
                    '<ul class="add-input-num">'+
                        '<li v-repeat="num in inputNum" v-touch="tap:inputThis"><span>{{num}}</span></li>'+
                        '<li><span>$</span></li>'+
                    '</ul>'+
                    '<ul class="add-input-tool">'+
                        '<li v-touch="tap:delThis"><span>X</span></li>'+
                        '<li><span>+</span></li>'+
                        '<li v-touch="tap:doThis"><span>确定</span></li>'+
                    '</ul>'+
                '</div>'+
            
            '</div>'

    })


    var App = Vue.extend({})

    var router = new VueRouter()

    router.map({
        '/': {
            component: Index
        },
        '/chart': {
            component: Chart
        },
        '/add':{
            component: Add
        }
    })

    router.start(App, '#app')
    </script>
</body>

</html>
