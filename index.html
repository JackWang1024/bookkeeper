<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/mui.min.css">
    <link rel="stylesheet" type="text/css" href="css/app-base.css" />
    <link rel="stylesheet" type="text/css" href="css/app-index.css" />
</head>

<body>
    <div id="app">
        <router-view></router-view>
    </div>
    <script src="js/vue.js"></script>
    <script src="js/vue-router.min.js"></script>
    <script src="js/vue-resource.min.js"></script>
    <script src="js/vue-async-data.js"></script>
    <script src="js/hammer.min.js"></script>
    <script src="js/vue-touch.js"></script>
    <script src="js/echarts.js"></script>
    <script src="js/pie.js"></script>
    <script>
    Vue.use(VueAsyncData);
    Vue.use(VueTouch);
    Vue.config.debug = true;

    Vue.filter('time2Day', function(str) {
        var time = new Date(str);
        return time.getFullYear() + "/" + (time.getMonth() + 1) + '/' + time.getDate();
    })

    // 作为入口
    require(
        [
            'echarts',
            'echarts/chart/pie'
        ]
    );

    var Index = Vue.extend({

        data: function() {
            imgs = ['img/test3.jpg', 'img/test2.jpg', 'img/test1.jpg', 'img/test4.jpg', 'img/test5.jpg', 'img/test6.jpg', 'img/test7.jpg', 'img/test8.jpg', 'img/test9.jpg', 'img/test10.jpg', 'img/test11.jpg', 'img/test12.jpg'];
            var cc = Math.round(Math.random() * imgs.length - 1);
            return {
                Index: {
                    bgimg: imgs[cc],
                    siteInfo: {
                        sitename: "Bookkeeper"
                    }
                }
            }
        },
        methods: {
            goBack: function(e) {
                history.go(-1);
            }
        },
        template: '<header class="header mui-bar mui-bar-nav"><h1 id="title" class="mui-title">{{Index.siteInfo.sitename}}</h1></header>' +
            '<div class="mui-content index-page" style="background-image: url({{Index.bgimg}})">' +
            '<div class="button-box">' +
            '<button v-link="chart" class="mui-btn go-button">开始记账</button><br>' +
            '<span></span>' +
            '</div>' +
            '</div>'

    })

    var Chart = Vue.extend({

        data: function() {
            var billList = [];
            if (localStorage.billList) {
                billList = JSON.parse(localStorage.billList);
                billList.reverse();
            }

            return {
                showModal: false,
                showAddModal: false,
                siteInfo: {
                    sitename: "Bookkeeper"
                },
                bills: billList,
                payment: 0,
                revenue: 0
            }
        },
        asyncData: function(resolve, reject) {
            var clist = [];
            var cdata = [];

            for (j = 0; j < this.$data.bills.length; j++) {
                this.$data.payment += parseFloat(this.$data.bills[j].price);
                if (clist.indexOf(this.$data.bills[j].category) == -1) {
                    clist.push(this.$data.bills[j].category);
                    cdata.push({
                        'name': this.$data.bills[j].category,
                        'value': 0
                    })
                }

            }
            this.$data.payment = parseFloat(this.$data.payment).toFixed(2);
            for (i = 0; i < this.$data.bills.length; i++) {
                for (n = 0; n < cdata.length; n++) {
                    if (this.$data.bills[i].category == clist[n]) {
                        cdata[n].value = cdata[n].value + parseFloat(this.$data.bills[i].price);
                    }
                }

            }
            var self = this;

            setTimeout(function() {
                self.$http.get('data/servicelist.json', function(data, status, request) {
                    resolve({

                    })
                    self.$nextTick(function() {
                        var myChart = require('echarts').init(document.getElementById('chart'));
                        myChart.setOption({
                            backgroundColor: 'rgb(156, 39, 176)',
                            calculable: false,
                            tooltip: {
                                trigger: 'item',
                                formatter: "{b} : {c} ({d}%)"
                            },
                            calculable: true,
                            series: [{
                                type: 'pie',
                                radius: ['50%', '70%'],
                                itemStyle: {
                                    normal: {
                                        label: {
                                            show: true
                                        },
                                        labelLine: {
                                            show: true
                                        }
                                    }
                                },
                                data: cdata
                            }]
                        });
                    });

                }).error(function(data, status, request) {

                });

            }, 1000)
        },
        methods: {
            goBack: function(e) {
                history.go(-1);
            },
            showAdd: function() {
                this.$data.showModal = true;
                this.$data.showAddModal = true;
            },
            close: function() {
                this.$data.showModal = false;
                this.$data.showAddModal = false;
            }
        },
        template: '<header class="header mui-bar mui-bar-nav"><a  v-on="click: goBack" class="mui-icon mui-icon-left-nav mui-pull-left"></a><button class="mui-btn mui-btn-link mui-btn-nav mui-pull-right"><span></span></button><h1 id="title" class="mui-title">{{siteInfo.sitename}}</h1></header>' +
            '<div class="modal-mask" v-if="showModal" v-transition="modal">' +
            '<div class="modal-wrapper">' +
            '<div class="modal-container" v-if="showAddModal">' +
            '<button v-touch="tap:close" class="close-modal-btn">×</button>' +
            '<content select=".modal-header">' +
            '<div class="modal-header">' +
            '添加' +
            '</div>' +
            '</content>' +
            '<content select=".modal-body">' +
            '<div class="modal-body">' +
            '<input class="doned-input" v-model="itemname" autofocus="autofocus">' +
            '<button class="doned-btn" v-on="click:add "> Done </button>' +
            '</div>' +
            '</content>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="mui-content chart-page">' +
            '<div class="chart">' +
            '<div class="chart-box">' +
            '<div id="chart"></div>' +
            '<div class="chart-txt">' +
            '<div class="chart-txt-left"><span>收入 ￥{{revenue}}</span></div>' +
            '<div class="chart-txt-left"><span>支出 ￥{{payment}}</span></div>' +
            '</div>' +
            '</div>' +
            '<div class="chart-list">' +
            '<div class="time-line"></div>' +
            '<ul>' +
            '<li v-link="/change/{{bill.timestamp}}" v-repeat="bill in bills">' +
            '<div class="bill-icon"></div>' +
            '<div class="bill-txt"><span class="bill-name">{{bill.category}}</span><span class="bill-price">{{bill.price}}</span><span class="bill-mark">{{bill.mark}}</span></div>' +
            '</li>' +
            '</ul>' +
            '</div>' +
            '</div>' +
            '<div class="add-box"  v-link="add">' +
            '<span>＋</span>' +
            '</div>' +
            '</div>'

    })

    var Add = Vue.extend({

        data: function() {

            var thetime = new Date();
            return {
                Index: {
                    siteInfo: {
                        sitename: "Bookkeeper"
                    },
                },
                thisTime: thetime,
                ModalShow: false,
                ModalMark: false,
                ModalMsg: "",
                price: 0,
                category: "",
                marked: "",
                categoryList: [{
                    "id": 1,
                    "name": "娱乐"
                }, {
                    "id": 2,
                    "name": "烟酒"
                }, {
                    "id": 3,
                    "name": "零食"
                }, {
                    "id": 4,
                    "name": "交通"
                }, {
                    "id": 5,
                    "name": "话费"
                }, {
                    "id": 6,
                    "name": "餐饮"
                }, {
                    "id": 7,
                    "name": "买菜"
                }, {
                    "id": 8,
                    "name": "购物"
                }],
                inputNum: [1, 2, 3, 4, 5, 6, 7, 8, 9, 0, '.']
            }
        },
        methods: {
            goBack: function(e) {
                history.go(-1);
            },
            setCategory: function(e) {
                var lables = document.getElementsByClassName('category-on');
                for (i = 0; i < lables.length; i++) {
                    lables[i].removeAttribute("class");
                }
                e.target.setAttribute('class', 'category-on');
                this.$data.category = e.target.innerText;
            },
            inputThis: function(e) {
                if (this.$data.price == 0) {
                    this.$data.price = e.target.innerText;
                } else {
                    this.$data.price += e.target.innerText;
                }

            },
            delThis: function() {
                if (this.$data.price != 0) {
                    this.$data.price = this.$data.price.substr(0, this.$data.price.length - 1);
                    if (this.$data.price.length == 0) {
                        this.$data.price = 0;
                    }
                }
            },
            doThis: function() {
                if (this.$data.price == 0) {
                    this.$data.ModalShow = true;
                    this.$data.ModalMsg = '没花钱？';
                } else if (this.$data.category.length == 0) {
                    this.$data.ModalShow = true;
                    this.$data.ModalMsg = '没选择分类';
                } else {
                    var timestamp = (new Date()).valueOf();
                    var time = new Date(this.$data.thisTime);
                    var bday = time.getFullYear() + "/" + (time.getMonth() + 1) + '/' + time.getDate();

                    var newbill = {
                        'category': this.$data.category,
                        'price': this.$data.price,
                        'mark': this.$data.marked,
                        'bday': bday,
                        'timestamp': timestamp
                    };
                    var billList = [];
                    if (localStorage.billList) {
                        billList = JSON.parse(localStorage.billList);
                    }
                    billList.push(newbill);
                    localStorage.billList = JSON.stringify(billList);
                    this.$data.ModalShow = true;
                    this.$data.ModalMsg = '已经帮你记好了~';
                    this.$data.price = 0;
                    this.$data.category = '';
                    var lables = document.getElementsByClassName('category-on');
                    for (i = 0; i < lables.length; i++) {
                        lables[i].removeAttribute("class");
                    }
                }
            },
            Modal: function(e, msg) {
                this.$data.ModalShow = true;
                this.$data.ModalMsg = msg;
            },
            close: function() {
                this.$data.ModalShow = false;
            },
            changeMark: function() {
                this.$data.ModalShow = true;
                this.$data.ModalMark = true;
            },
            setMark: function() {
                this.$data.ModalShow = false;
                this.$data.ModalMark = false;
            }
        },
        template: '<header class="header mui-bar mui-bar-nav"><a  v-on="click: goBack" class="mui-icon mui-icon-left-nav mui-pull-left"></a><h1 id="title" class="mui-title">{{Index.siteInfo.sitename}}</h1></header>' +
            '<div class="modal-mask" v-if="ModalShow" v-transition="modal">' +
            '<div class="modal-wrapper">' +
            '<div class="modal-container" >' +
            '<button v-touch="tap:close" class="close-modal-btn">×</button>' +
            '<content select=".modal-header">' +
            '<div class="modal-header">' +
            '</div>' +
            '</content>' +
            '<content select=".modal-body" v-if="!ModalMark">' +
            '<div class="modal-body">' +
            '<p>{{ModalMsg}}</p>' +
            '<button class="doned-btn" v-on="click:ModalShow = false "> OK </button>' +
            '</div>' +
            '</content>' +
            '<content select=".modal-body" v-if="ModalMark">' +
            '<div class="modal-body">' +
            '<input class="doned-input" v-model="marked" autofocus="autofocus">' +
            '<button class="doned-btn" v-on="click:setMark "> Done </button>' +
            '</div>' +
            '</content>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="mui-content add-page">' +
            '<div class="add-price-box"><span class="add-price">￥{{price}}</span></div>' +
            '<div class="add-category">' +
            '<ul>' +
            '<li class="category-item" v-repeat="c in categoryList" v-touch="tap:setCategory"><div><div data="{{c.id}}">{{c.name}}</div></li>' +
            '</ul>' +
            '</div>' +
            '<div class="add-time">' +
            '<div class="add-time-btn">' +
            '<label for="addingtime">{{thisTime | time2Day}}</label><input id="addingtime" type="date" v-model="thisTime"/>' +
            '</div>' +
            '<div class="add-mark-box">' +
            '<div class="add-mark-btn" v-touch="tap:changeMark">添加备注</div>' +
            '</div>' +
            '<div class="add-marked-box">' +
            '<div class="">{{marked}}</div>' +
            '</div>' +
            '</div>' +
            '<div class="add-input-box">' +
            '<ul class="add-input-num">' +
            '<li v-repeat="num in inputNum" v-touch="tap:inputThis"><span>{{num}}</span></li>' +
            '<li><span>$</span></li>' +
            '</ul>' +
            '<ul class="add-input-tool">' +
            '<li v-touch="tap:delThis"><span>X</span></li>' +
            '<li><span>+</span></li>' +
            '<li v-touch="tap:doThis"><span>确定</span></li>' +
            '</ul>' +
            '</div>' +

            '</div>'

    })
    var Change = Vue.extend({

        data: function() {
            var billList = JSON.parse(localStorage.billList);
            var bill = {};
            for (i = 0; i < billList.length; i++) {
                if (billList[i].timestamp == this.$route.params.timestamp) {
                    bill = billList[i];
                }
            }
            var thetime = new Date(bill.bday);
            return {
                Index: {
                    siteInfo: {
                        sitename: "Bookkeeper"
                    },
                },
                thisTime: thetime,
                ModalShow: false,
                ModalMark: false,
                ModalMsg: "",
                KeyShow:false,
                timestamp:bill.timestamp,
                price: bill.price,
                category: bill.category,
                marked: bill.mark,
                categoryList: [{
                    "id": 1,
                    "name": "娱乐"
                }, {
                    "id": 2,
                    "name": "烟酒"
                }, {
                    "id": 3,
                    "name": "零食"
                }, {
                    "id": 4,
                    "name": "交通"
                }, {
                    "id": 5,
                    "name": "话费"
                }, {
                    "id": 6,
                    "name": "餐饮"
                }, {
                    "id": 7,
                    "name": "买菜"
                }, {
                    "id": 8,
                    "name": "购物"
                }],
                inputNum: [1, 2, 3, 4, 5, 6, 7, 8, 9, 0, '.']
            }
        },
        asyncData: function(resolve, reject) {
            this.$nextTick(function() {
                var lables = document.getElementsByClassName('category-name');
                for (i = 0; i < lables.length; i++) {
                    if(lables[i].innerText == this.$data.category){
                        lables[i].setAttribute('class', 'category-name category-on');
                    }
                }
            })
        },
        methods: {
            goBack: function(e) {
                history.go(-1);
            },
            setCategory: function(e) {
                var lables = document.getElementsByClassName('category-on');
                for (i = 0; i < lables.length; i++) {
                    lables[i].removeAttribute("class");
                }
                e.target.setAttribute('class', 'category-on');
                this.$data.category = e.target.innerText;
            },
            inputThis: function(e) {
                if (this.$data.price == 0) {
                    this.$data.price = e.target.innerText;
                } else {
                    this.$data.price += e.target.innerText;
                }

            },
            delThis: function() {
                if (this.$data.price != 0) {
                    this.$data.price = this.$data.price.substr(0, this.$data.price.length - 1);
                    if (this.$data.price.length == 0) {
                        this.$data.price = 0;
                    }
                }
            },
            delBill:function(){
                var billList = JSON.parse(localStorage.billList);
                for (i = 0; i < billList.length; i++) {
                    if (billList[i].timestamp == this.$route.params.timestamp) {
                        billList.splice(i,1);
                    }
                }
                localStorage.billList = JSON.stringify(billList);
                router.go('/chart');
            },
            doThis: function() {
                if (this.$data.price == 0) {
                    this.$data.ModalShow = true;
                    this.$data.ModalMsg = '没花钱？';
                } else if (this.$data.category.length == 0) {
                    this.$data.ModalShow = true;
                    this.$data.ModalMsg = '没选择分类';
                } else {
                    var time = new Date(this.$data.thisTime);
                    var bday = time.getFullYear() + "/" + (time.getMonth() + 1) + '/' + time.getDate();

                    var billList = JSON.parse(localStorage.billList);
                    for (i = 0; i < billList.length; i++) {
                        if (billList[i].timestamp == this.$route.params.timestamp) {
                            billList[i] = {
                                'category': this.$data.category,
                                'price': this.$data.price,
                                'mark': this.$data.marked,
                                'bday': bday,
                                'timestamp':this.$data.timestamp
                            }
                        }
                    }

                    localStorage.billList = JSON.stringify(billList);
                    this.$data.ModalShow = true;
                    this.$data.ModalMsg = '已经帮你记好了~';
                }
            },
            Modal: function(e, msg) {
                this.$data.ModalShow = true;
                this.$data.ModalMsg = msg;
            },
            close: function() {
                this.$data.ModalShow = false;
            },
            changeMark: function() {
                this.$data.ModalShow = true;
                this.$data.ModalMark = true;
            },
            setMark: function() {
                this.$data.ModalShow = false;
                this.$data.ModalMark = false;
            }
        },
        template: '<header class="header mui-bar mui-bar-nav"><a  v-on="click: goBack" class="mui-icon mui-icon-left-nav mui-pull-left"></a><h1 id="title" class="mui-title">{{Index.siteInfo.sitename}}</h1></header>' +
            '<div class="modal-mask" v-if="ModalShow" v-transition="modal">' +
            '<div class="modal-wrapper">' +
            '<div class="modal-container" >' +
            '<button v-touch="tap:close" class="close-modal-btn">×</button>' +
            '<content select=".modal-header">' +
            '<div class="modal-header">' +
            '</div>' +
            '</content>' +
            '<content select=".modal-body" v-if="!ModalMark">' +
            '<div class="modal-body">' +
            '<p>{{ModalMsg}}</p>' +
            '<button class="doned-btn" v-on="click:ModalShow = false "> OK </button>' +
            '</div>' +
            '</content>' +
            '<content select=".modal-body" v-if="ModalMark">' +
            '<div class="modal-body">' +
            '<input class="doned-input" v-model="marked" autofocus="autofocus">' +
            '<button class="doned-btn" v-on="click:setMark "> Done </button>' +
            '</div>' +
            '</content>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="mui-content add-page">' +
            '<div class="add-price-box" v-touch="tap:KeyShow = true"><span class="add-price">￥{{price}}</span></div>' +
            '<div class="add-category">' +
            '<ul>' +
            '<li class="category-item" v-repeat="c in categoryList" v-touch="tap:setCategory"><div><div data="{{c.id}}" class="category-name">{{c.name}}</div></li>' +
            '</ul>' +
            '</div>' +
            '<div class="add-time">' +
            '<div class="add-time-btn">' +
            '<label for="addingtime">{{thisTime | time2Day}}</label><input id="addingtime" type="date" v-model="thisTime"/>' +
            '</div>' +
            '<div class="add-mark-box">' +
            '<div class="add-mark-btn" v-touch="tap:changeMark">添加备注</div>' +
            '</div>' +
            '<div class="add-marked-box">' +
            '<div class="">{{marked}}</div>' +
            '</div>' +
            '</div>' +
            '<div class="add-btn-box" v-if="!KeyShow">'+
                '<div><button v-touch="tap:delBill">删除</button></div>'+
                '<div><button class="mui-btn mui-btn-success" v-touch="tap:doThis">保存</button></div>'+
            '</div>'+
            '<div class="add-input-box" v-if="KeyShow">' +
            '<ul class="add-input-num">' +
            '<li v-repeat="num in inputNum" v-touch="tap:inputThis"><span>{{num}}</span></li>' +
            '<li><span>$</span></li>' +
            '</ul>' +
            '<ul class="add-input-tool">' +
            '<li v-touch="tap:delThis"><span>X</span></li>' +
            '<li><span>+</span></li>' +
            '<li v-touch="tap:KeyShow = false"><span>确定</span></li>' +
            '</ul>' +
            '</div>' +

            '</div>'

    })


    var App = Vue.extend({})

    var router = new VueRouter()

    router.map({
        '/': {
            component: Index
        },
        '/chart': {
            component: Chart
        },
        '/add': {
            component: Add
        },
        '/change/:timestamp': {
            component: Change
        }
    })

    router.start(App, '#app')
    </script>
</body>

</html>
